---
inclusion: always
---

## 技術スタック

### 全体

- **パッケージマネージャー**: pnpm
- **ランタイム**: Node.js
- **フォーマッター**: biome
- **プロジェクト管理**: モノレポ構成

### フロントエンド

- **フレームワーク**: 
  - Next.js (App Router)
  - Mastra
- **言語**: 
  - TypeScript
- **スタイリング**:
  - TailwindCSS
  - Shadcn/ui
- **ライブラリ**：
  - Vercel AI SDK V4
  - x402-mcp
  - x402-fetch
  - x402-next
- **状態管理**: 
  - useState

### ブロックチェーン

- **baseSepolia**: Baseのテストネット
- **USDC**: x402で扱うステーブルコイン

### インフラ

- **AWS**
  - **リソース管理**: AWS CDK(TypeScript) 
    - x402のバックエンドサーバー
    - AgentCoreのリソース

## 開発ツール設定

### パッケージマネージャー

- **pnpm**: 高速で効率的なパッケージ管理
- `pnpm-workspace.yaml`: モノレポワークスペース設定

### フォーマッター・リンター

- **Biome**: 高速なフォーマッターとリンター
- `biome.json`: 設定ファイル

### Git 設定

- `.gitignore`: 必須除外項目
  - `**/node_modules`
  - `**/.DS_Store`

## 採用する技術について補足情報

# Mastraについて

## Mastra(マストラ): AIエージェント開発のためのTypeScriptフレームワーク

### 🚀 概要

Mastraは、TypeScript/JavaScriptで開発されたオープンソースのAIエージェント開発フレームワークです。LLM(大規模言語モデル)を活用したインテリジェントなアプリケーションやエージェントを、効率的かつ構造的に構築・デプロイするために必要なコンポーネントと開発環境を包括的に提供します。

| 項目 | 詳細 |
|------|------|
| 開発言語 | TypeScript / JavaScript |
| 特徴 | AIエージェント構築に必要な機能をオールインワンで提供。TypeScriptの型安全性を活かした高い開発者体験(DX)を重視 |
| 対応LLM | OpenAI(GPT-4など)、Anthropic(Claude)、Google(Gemini)など、複数のLLMを統一インターフェースで利用可能 |
| 適用範囲 | 対話型アシスタント、自律的なタスク実行エージェント、情報収集・分析の自動化など、複雑なAIアプリケーション全般 |

### 🛠️ 主要な機能とコンポーネント

Mastraは、AIエージェントの構築・運用を支援する以下の主要なコンポーネントを提供します。

#### 1. Agents(エージェント)

LLMを活用し、特定の目的達成のために自律的にタスクを実行するAIシステムの中核です。

- **機能**: ツール呼び出し(Tool Calling)、メモリ管理、対話履歴の保持などを行い、ユーザーの問い合わせや指示に応じて動的に最適なアクションを実行します
- **構造化出力**: ZodやJSON Schemaを使用して期待される出力形式を定義することで、型安全な構造化データを取得できます

#### 2. Workflows(ワークフロー)

複雑なタスクを複数のステップに分割し、安定的に実行するためのグラフベースのステートマシンです。

- **機能**: 複数のLLM呼び出しやデータ処理ステップをグラフ構造で視覚的に定義・管理できます
- **制御**: 条件分岐、ループ処理、他のワークフローの組み込み、エラーハンドリング(リトライ)、ヒューマン・イン・ザ・ループ(人間による入力待ち)などが可能です
- **耐久性**: 実行時のログやトレース情報が自動で記録され、デバッグや監視(Observability)が容易です

#### 3. RAG(Retrieval-Augmented Generation / 検索拡張生成)

エージェントに外部の知識ベース(ドキュメント、データベースなど)と連携する能力を与え、回答の正確性を向上させる機能です。

- **機能**: ドキュメントの分割、埋め込み(Embedding)、ベクトルデータベースへの保存、クエリ時の関連情報取得、再ランク付けなどを簡易に行えます
- **利用**: 社内ドキュメントやWebスクレイピングで収集したデータなど、アプリケーション固有の知識をエージェントの応答に活用できます

#### 4. Tools(ツール)

エージェントが外部システムと連携するための手段です。

- **機能**: 外部APIやカスタム関数を型安全に定義し、エージェントから呼び出すことができます
- **連携**: エージェントは、タスク実行に必要な情報取得やアクションのために、どのツールをいつ、どのようなパラメータで呼び出すかを自律的に判断します

#### 5. Memory(メモリ)

エージェントの過去の対話や知識を保持し、長期にわたって学習・維持するための仕組みです。

**種類:**

- **ワーキングメモリ**: 現在の対話の文脈を扱う短期記憶
- **セマンティックメモリ**: 過去の対話履歴などをベクトル検索で動的に思い出す長期記憶
- **永続化**: 記憶した内容はLibSQLなどを用いて永続化することが可能です

#### 6. 評価(Evals)

LLMの出力品質を自動でテスト・評価するための機能です。

- **目的**: LLMの応答が、有害性、バイアス、関連性などの基準を満たしているかを客観的に評価し、エージェントの品質向上をサポートします

#### 7. 開発環境とOps

開発効率と運用管理を支援する機能です。

- **ローカル開発環境 & Playground**: 開発中のエージェントやワークフローの動作をリアルタイムで確認・テストできるブラウザ上のGUIを提供します
- **デプロイ**: Node.js、サーバーレス環境など、多様な環境へのデプロイを容易にします
- **Ops**: エージェントとワークフローのパフォーマンス管理、トレーシング、監視機能を提供します

### 💡 活用事例

Mastraで構築可能なAIエージェントの具体的な応用例には以下のようなものがあります。

- **カスタマーサポートの自動化**: RAG機能を用いてFAQやナレッジベースと連携し、顧客からの問い合わせに自動で回答するチャットボット
- **情報収集・リサーチの自動化**: Webスクレイピングやデータ分析ツールを組み合わせ、市場調査、競合分析、営業リストの作成などを自動実行するエージェント
- **専門ドキュメントの生成・分析**: 大量の技術文書やレポートを解析し、要約・情報抽出を行ったり、設計図やレポートを自動生成したりするアシスタント
- **プログラミング支援**: コードの自動生成、バグ修正提案、コードレビューコメントの作成を行う開発アシスタント
- **マルチエージェント構成**: 役割を分担した複数のエージェント(Web検索エージェント、データ分析エージェントなど)を連携させ、複雑なタスクを協力して実行させるシステム

### 🌟 強みと特徴

- **TypeScript/Webスタックとの親和性**: TypeScriptで完結するため、既存のWeb開発技術やエコシステムとの連携がスムーズです
- **オールインワンフレームワーク**: エージェント、ワークフロー、RAG、評価、デプロイなど、開発から運用に必要な要素が一通り揃っています
- **開発者体験(DX)の重視**: 型安全性、統合された開発環境(Playground)、デバッグ支援機能(トレーシング、Evals)により、高品質なエージェントを効率的に開発できます
- **柔軟な制御と拡張性**: ワークフローによる複雑な処理フローの定義や、ツールによる外部連携が容易であり、高度で自律的なAIアプリケーションの構築に適しています

---

# Amazon Bedrock AgentCoreについて

## 🛡️ Amazon Bedrock AgentCore: エンタープライズ向けAIエージェント実行基盤

### 🚀 概要

Amazon Bedrock AgentCoreは、あらゆるフレームワークやLLM上で動作するAIエージェントを、エンタープライズグレードのセキュリティ、信頼性、ガバナンスを確保しながら、プロトタイプ(PoC)から本番環境へ安全にスケール展開するためのフルマネージドサービス群です。

AIエージェントのインフラストラクチャ管理や複雑なセキュリティ要件をAWSが肩代わりすることで、開発者はエージェントのロジック開発に集中し、市場投入までの時間(Time to Value)を短縮できます。

| 項目 | 詳細 |
|------|------|
| 提供形態 | フルマネージドサービス |
| 特徴 | フレームワーク・モデル非依存の実行基盤。エンタープライズ向けのセキュリティ・ガバナンス機能が組み込み済み |
| 目的 | AIエージェントの本番環境へのデプロイ、スケーリング、運用を加速・簡素化 |
| 対応フレームワーク | LangGraph、CrewAI、Strands Agentなど、主要なオープンソースフレームワークをサポート |

### 🛠️ 主要な機能とコンポーネント

AgentCoreは、エージェントを大規模に運用するために不可欠な以下の機能を、マネージドサービスとして提供します。

#### 1. AgentCore Runtime(実行環境)

エージェントの実行を担う、セキュアなサーバーレスインフラストラクチャです。

- **セッション分離**: エージェント実行環境を完全に隔離し、データ漏えいを防ぎます
- **長時間ワークロード**: 低遅延のリアルタイム処理に加え、最大8時間にわたる非同期かつ複雑なワークロードをサポートします
- **スケーラビリティ**: 数千のエージェント呼び出しセッションへの自動スケールアップに対応します
- **リカバリ**: チェックポイント作成とリカバリ機能により、処理の中断からの復旧をサポートします

#### 2. Built-in Tools(組み込みツール)

エージェントの能力を拡張するための、セキュリティが担保されたマネージドツールです。

**Code Interpreter**

エージェントがサンドボックス化された隔離環境でコードを実行する機能です。

- **機能**: 計算、データ処理、可視化などを安全に実行できます
- **対応言語**: Python、JavaScript、TypeScriptの実行ランタイムをプリビルトで提供

**Browser Tool**

エージェントがクラウドベースのブラウザを操作するための実行環境です。

- **機能**: フォーム入力、サイトナビゲーション、Webスクレイピングなど、Web操作を安全かつスケーラブルに自動化します
- **可視化**: ライブビューやセッション記録の再生により、エージェントのブラウザ操作を監視・検証できます

#### 3. AgentCore Gateway(ゲートウェイ)

既存のエンタープライズリソースを、エージェントが利用できるツールに変換し、アクセスを管理する機能です。

- **ツール化の簡素化**: 既存のWeb APIやLambda関数などを、わずか数行のコードでエージェント対応ツールに変換します
- **認証・認可の統合**: AgentCore Identityと連携し、エージェントの外部ツールへのアクセスに対するOAuthなどの認可(Outbound)を統合的に管理します
- **インテリジェントなツール発見**: セマンティック検索により、登録された多数のツールの中から、タスクのコンテキストに基づいて適切なツールをエージェントが迅速に発見できます

#### 4. AgentCore Memory(記憶管理)

エージェントの会話コンテキストと知識を管理する機能で、インフラ管理は不要です。

- **短期メモリ**: マルチターン会話向けの会話履歴をイベントとして保存し、セッション内のコンテキストを維持します
- **長期メモリ**: 会話の要約、確認された知識、ユーザーの好みなど、セッションをまたいで引き継ぐべき重要な洞察を保存・検索できます

#### 5. AgentCore Identity(認証・認可)

エージェントのアクセス管理を統合し、エンタープライズレベルのセキュリティを実現します。

- **連携**: Amazon Cognito、Microsoft Entra IDなどの既存のIDプロバイダとシームレスに連携できます
- **統制**: エージェントのインバウンド/アウトバウンド両方の認証・認可を管理し、社内セキュリティポリシーに沿った安全な運用を可能にします

#### 6. AgentCore Observability(可観測性)

エージェントの動作状況を監視・分析するための機能です。

- **可視化**: 直感的なダッシュボードを通じて、エージェントのステップごとの動作、LLMの呼び出し回数、レイテンシなどを詳細に把握できます
- **標準対応**: OpenTelemetry標準フォーマットに対応しており、Amazon CloudWatch、Datadog、LangSmith、Langfuseなど既存のオブザーバビリティツールとの連携が容易です

### 🌟 AgentCoreの主な利点

- **インフラ管理の排除**: エージェント実行のためのサーバーレスインフラ、スケーリング、高可用性、セキュリティ要件をすべてAWSがマネージドで提供
- **高い柔軟性**: 任意のLLM、任意のオープンソースエージェントフレームワーク(LangChain、LangGraphなど)を選択してデプロイ・運用できます
- **エンタープライズセキュリティ**: セッション隔離、ID管理、ツールアクセス制御が組み込まれており、本番環境で求められる厳しいガバナンス要件を満たします
- **機能拡張の容易さ**: Code InterpreterやBrowser Toolなどの組み込みツール、およびGatewayによる既存APIのツール化により、エージェントの実行能力を迅速かつ安全に拡張できます

---

# x402について

## 💰 x402: AIエコノミーのためのインターネットネイティブ決済プロトコル

### 🚀 概要

x402は、自律的なAIエージェントやAPI間のマイクロペイメント(超少額決済)をシームレスかつ摩擦なく実行するために設計された、新しい決済プロトコルです。

- **プロトコル名**: x402
- **中核技術**: HTTPステータスコード 402("Payment Required")の活用
- **目的**: ソフトウェアが人間の介入なしに経済取引を自律的に行える「自動化された経済」を実現すること
- **主な焦点**: API、アプリ、AIエージェントが、利用したリソースに対してリアルタイムで、極めて低額の支払い(マイクロペイメント)を行えるようにすること

### 🛠️ x402の機能と特徴

x402は、従来の決済システムが抱える課題(複雑なAPIキー、高い手数料、遅延など)を解決し、AI時代の経済活動に最適化されています。

#### 1. HTTPネイティブな決済フロー

- **HTTP 402の活用**: 長らく予約されて利用されていなかったHTTPステータスコード402を復活させ、既存のHTTP通信の中に自然な形で決済フローを差し込みます
- **仕組み**: サービスへのリクエストが402で拒否された場合、レスポンスには支払い要求(どのデジタル資産で、いくら支払うか)が含まれており、クライアント(AIエージェントなど)はそれに応じた支払い署名を添付してリクエストを再送信します

#### 2. マイクロペイメントとリアルタイム決済

- **超低額支払い**: 0.001ドル単位のような極めて少額の支払い(マイクロペイメント)も、経済的に実行可能です
- **即時決済**: サービス提供と同時に支払いが確定する即時決済を実現し、取引の不確実性を排除します
- **正確な計測**: API呼び出しや計算リソースの使用量をミリ秒単位で正確に測定し、使用量に基づいた公平な課金を実現します

#### 3. AIエージェントの経済的自律性

- **経済的主体**: AIエージェントが、人間が設定したサブスクリプションやAPIキーに依存せず、自らの判断で経済取引を行えるようになります
- **ツール連携**: Mastraなどで活用されるMCP(Model Context Protocol)のような標準的なツール連携を通じて、エージェントが自動的に支払い処理を実行できます

#### 4. 開発・運用面での利点

- **シームレスな統合**: 既存のWebスタックへの統合が容易で、数行のミドルウェアコードや設定の追加で行えます
- **APIキー不要**: 支払い署名がアクセス認証を兼ねるため、複雑なAPIキーの管理が不要になります
- **自動スケーリング**: 使用量に応じて自動的にスケールする料金構造が容易になり、リソースの最適化が図れます

### 💡 x402が実現する応用シナリオ

x402は、以下のような新しいデジタルエコノミーの実現を可能にします。

#### 1. AIエージェント間の自動取引

- **リソースの購入**: AIエージェントが、タスク実行に必要なGPU/CPU時間、専門的なデータ、外部APIサービスなどを、リアルタイムで自律的に購入し、リソースを最適に配分します
- **複雑なタスクの自動実行**: 複数のAIエージェントやサービスを組み合わせた複雑なワークフローにおいて、各ステップでのコストを自動で支払い、人間の承認なしにタスクを最後まで実行します

#### 2. データ・コンテンツの利用高度化

- **動的なコンテンツ課金**: 動画の視聴時間、ニュース記事の閲覧量、ゲームのプレイ時間など、実際の利用量に基づいた柔軟な課金体系(従量課金)が容易に実現します
- **専門情報のオンデマンド購入**: 市場データや気象情報などの専門データサービスを、必要な時だけ、必要な分だけ購入し、AIによる高度な分析・提案に活用できます

#### 3. グローバルな分散型経済

- **摩擦のないグローバル取引**: 地理的な制限や複雑な銀行手続きなしに、インターネット上のすべてのデジタル資産が直接かつ即時に取引可能になります
- **クリエイターへの公平な還元**: 中抜きを減らし、コンテンツの利用量に比例した収益が、クリエイターに直接かつ瞬時に還元されることが期待されます